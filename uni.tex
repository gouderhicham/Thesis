\documentclass{article}
\usepackage{pgf-umlsd}

\begin{document}

\begin{sequencediagram}
  
  % Participants
  \newthread{U}{User}
  \newinst[2]{S}{System}
  \newinst[2]{DB}{Database}
  \newinst[2]{Log}{Logger}

  % Initial Request
  \begin{call}{U}{Request Data}{S}{}
    \begin{sdblock}{loop}{For each item}
      \begin{call}{S}{Query Item}{DB}{Result}
      \end{call}
      \begin{call}{S}{Process Data}{S}{Processed Data}
      \end{call}
      \begin{sdblock}{alt}{Condition met?}
        \begin{call}{S}{Send Response}{U}{Success}
        \end{call}
        \mess{S}{Error Handling}{U}
      \end{sdblock}
    \end{sdblock}

    \begin{call}{S}{Store Processed Data}{DB}{Success}
    \end{call}

    \begin{call}{S}{Log Transaction}{Log}{Logged}
    \end{call}

    \mess{S}{Final Confirmation}{U}

  \end{call}

\end{sequencediagram}

\end{document}
